<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¿ã‚¹ã‚¯è©³ç´° - Schedule App</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        nav {
            background: #1a1a1a;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-link-btn, .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .nav-link-btn:hover, .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 2rem;
            flex: 1;
            width: 100%;
        }

        .back-btn {
            display: inline-block;
            margin-bottom: 1.5rem;
            color: #2c2c2c;
            text-decoration: none;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: #e0e0e0;
        }

        .task-detail {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .task-title-section h1 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 2rem;
        }

        .task-meta {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        .meta-item {
            color: #666;
        }

        .meta-item strong {
            color: #333;
            font-weight: 600;
        }

        .task-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .task-status {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .status-todo {
            background: #e9ecef;
            color: #495057;
        }

        .status-progress {
            background: #ffc107;
            color: white;
        }

        .status-done {
            background: #28a745;
            color: white;
        }

        .status-dropdown {
            position: relative;
            display: inline-block;
        }

        .status-menu {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            min-width: 150px;
            top: 100%;
            right: 0;
        }

        .status-menu.show {
            display: block;
        }

        .status-option {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.95rem;
        }

        .status-option:hover {
            background: #f0f0f0;
        }

        .status-option:first-child {
            border-radius: 8px 8px 0 0;
        }

        .status-option:last-child {
            border-radius: 0 0 8px 8px;
        }

        .help-button {
            padding: 0.75rem 1.5rem;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .help-button:hover {
            background: #ff5252;
        }

        .help-button.active {
            background: #28a745;
        }

        .help-button.active:hover {
            background: #228b3f;
        }

        .task-description {
            margin-bottom: 2rem;
        }

        .task-description h3 {
            color: #333;
            margin-bottom: 1rem;
        }

        .description-text {
            color: #666;
            line-height: 1.6;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .help-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }

        .help-section h2 {
            color: #856404;
            margin-bottom: 0.5rem;
        }

        .help-section p {
            color: #856404;
            margin-bottom: 1rem;
        }

        .messages-section {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .messages-section h3 {
            color: #333;
            margin-bottom: 1.5rem;
        }

        .message-list {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .message-box {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #2c2c2c;
        }

        .message-author {
            font-weight: 600;
            color: #2196F3;
            margin-bottom: 0.25rem;
        }

        .message-time {
            font-size: 0.85rem;
            color: #999;
            margin-bottom: 0.5rem;
        }

        .message-text {
            color: #333;
            line-height: 1.5;
            word-break: break-word;
        }

        .message-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        textarea {
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #2c2c2c;
        }

        .btn {
            padding: 0.875rem 2rem;
            background: #2c2c2c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #3a3a3a;
            transform: translateY(-2px);
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #888;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #888;
        }

        @media (max-width: 768px) {
            .task-header {
                flex-direction: column;
                gap: 1.5rem;
            }

            .task-title-section h1 {
                font-size: 1.5rem;
            }

            .message-list {
                max-height: 300px;
            }

            .container {
                padding: 0 1rem;
            }
        }
    </style>
</head>
<body>

<nav>
    <div class="nav-left">
        <a href="/groups.html" class="logo">Schedule App</a>
    </div>
    <div class="nav-buttons">
        <button class="nav-link-btn" onclick="window.location.href='/schedule.html'">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</button>
        <button class="nav-link-btn" onclick="window.location.href='/groups.html'">ã‚°ãƒ«ãƒ¼ãƒ—</button>
        <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
</nav>

<div class="container">
    <a href="/groups.html" class="back-btn">â† ã‚°ãƒ«ãƒ¼ãƒ—ã«æˆ»ã‚‹</a>

    <div class="task-detail">
        <div class="task-header">
            <div class="task-title-section">
                <h1 id="taskTitle">ã‚¿ã‚¹ã‚¯å</h1>
                <div class="task-meta">
                    <div class="meta-item">
                        <strong>ã‚°ãƒ«ãƒ¼ãƒ—:</strong> <span id="groupName">-</span>
                    </div>
                    <div class="meta-item">
                        <strong>ä½œæˆè€…:</strong> <span id="creatorName">-</span>
                    </div>
                    <div class="meta-item">
                        <strong>ä½œæˆæ—¥:</strong> <span id="createdDate">-</span>
                    </div>
                </div>
            </div>
            <div class="task-controls">
                <div class="status-dropdown">
                    <button class="task-status" id="statusBtn" onclick="toggleStatusMenu()">
                        <span id="statusLabel">æœªç€æ‰‹</span>
                    </button>
                    <div class="status-menu" id="statusMenu">
                        <button class="status-option" onclick="updateStatus('TODO')">æœªç€æ‰‹</button>
                        <button class="status-option" onclick="updateStatus('IN_PROGRESS')">é€²è¡Œä¸­</button>
                        <button class="status-option" onclick="updateStatus('DONE')">å®Œäº†</button>
                    </div>
                </div>
                <button class="help-button" id="helpBtn" onclick="toggleHelpFlag()">
                    <span id="helpBtnText">ğŸ†˜ ãƒ˜ãƒ«ãƒ—ã‚’æ±‚ã‚ã‚‹</span>
                </button>
            </div>
        </div>

        <div class="task-description">
            <h3>èª¬æ˜</h3>
            <div class="description-text" id="descriptionText">
                èª¬æ˜ãŒã‚ã‚Šã¾ã›ã‚“
            </div>
        </div>
    </div>

    <!-- ãƒ˜ãƒ«ãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="helpSection" style="display: none;" class="help-section">
        <h2>ğŸ†˜ ãƒ˜ãƒ«ãƒ—ãŒæ±‚ã‚ã‚‰ã‚Œã¦ã„ã¾ã™</h2>
        <p>ã“ã®ã‚¿ã‚¹ã‚¯ã«å¯¾ã—ã¦ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã‹ã‚‰æ”¯æ´ã‚’å—ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¬„ã‚’ä½¿ç”¨ã—ã¦è³ªå•ã‚„ç›¸è«‡ã‚’ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="messagesSection" style="display: none;" class="messages-section">
        <h3>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
        
        <div class="message-list" id="messagesList">
            <div class="loading">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div class="message-form">
            <textarea id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            <button class="btn" onclick="sendMessage()">é€ä¿¡</button>
        </div>
    </div>
</div>

<script>
let currentUser = null;
let currentTask = null;
let taskId = null;

window.onload = async function() {
    taskId = new URLSearchParams(window.location.search).get('taskId');
    
    if (!taskId) {
        alert('ã‚¿ã‚¹ã‚¯IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        window.location.href = '/groups.html';
        return;
    }

    await checkLogin();
    if (currentUser) {
        await loadTask();
    }
};

async function checkLogin() {
    try {
        const res = await fetch('/api/current-user');
        const data = await res.json();
        
        if (data.loggedIn) {
            currentUser = data.username;
        } else {
            window.location.href = '/auth.html';
        }
    } catch (error) {
        console.error('Error checking login:', error);
        window.location.href = '/auth.html';
    }
}

async function logout() {
    try {
        await fetch('/api/logout', { method: 'POST' });
        window.location.href = '/auth.html';
    } catch (error) {
        console.error('Logout error:', error);
        alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
}

async function loadTask() {
    try {
        const res = await fetch(`/api/tasks/${taskId}`);
        const task = await res.json();
        
        if (!task || !task.id) {
            alert('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            window.location.href = '/groups.html';
            return;
        }

        currentTask = task;

        // ã‚¿ã‚¹ã‚¯æƒ…å ±ã‚’è¡¨ç¤º
        document.getElementById('taskTitle').textContent = escapeHtml(task.title);
        document.getElementById('creatorName').textContent = escapeHtml(task.creatorUsername || 'ä¸æ˜');
        document.getElementById('createdDate').textContent = formatDate(task.createdAt);
        document.getElementById('descriptionText').textContent = escapeHtml(task.description) || 'èª¬æ˜ãŒã‚ã‚Šã¾ã›ã‚“';
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤º
        updateStatusDisplay(task.status);
        
        // ãƒ˜ãƒ«ãƒ—ãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
        if (task.isHelpNeeded) {
            document.getElementById('helpSection').style.display = 'block';
            document.getElementById('messagesSection').style.display = 'block';
            updateHelpButtonDisplay(true);
            await loadMessages();
        } else {
            document.getElementById('helpSection').style.display = 'none';
            document.getElementById('messagesSection').style.display = 'none';
            updateHelpButtonDisplay(false);
        }
    } catch (error) {
        console.error('Error loading task:', error);
        alert('ã‚¿ã‚¹ã‚¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
}

function updateStatusDisplay(status) {
    const statusLabel = {
        'TODO': 'æœªç€æ‰‹',
        'IN_PROGRESS': 'é€²è¡Œä¸­',
        'DONE': 'å®Œäº†'
    };

    const btn = document.getElementById('statusBtn');
    btn.className = `task-status status-${(status || 'TODO').toLowerCase()}`;
    document.getElementById('statusLabel').textContent = statusLabel[status] || status;
}

function updateHelpButtonDisplay(isHelpNeeded) {
    const btn = document.getElementById('helpBtn');
    const text = document.getElementById('helpBtnText');
    
    if (isHelpNeeded) {
        btn.classList.add('active');
        text.textContent = 'âœ“ ãƒ˜ãƒ«ãƒ—ãŒæœ‰åŠ¹ã§ã™';
    } else {
        btn.classList.remove('active');
        text.textContent = 'ğŸ†˜ ãƒ˜ãƒ«ãƒ—ã‚’æ±‚ã‚ã‚‹';
    }
}

function toggleStatusMenu() {
    const menu = document.getElementById('statusMenu');
    menu.classList.toggle('show');
}

async function updateStatus(newStatus) {
    try {
        const res = await fetch(`/api/tasks/${taskId}/status`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status: newStatus})
        });

        const data = await res.json();
        
        if (data.success) {
            currentTask.status = newStatus;
            updateStatusDisplay(newStatus);
            document.getElementById('statusMenu').classList.remove('show');
        } else {
            alert(data.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error('Error updating status:', error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}

async function toggleHelpFlag() {
    const newValue = currentTask.isHelpNeeded ? 0 : 1;
    
    try {
        const res = await fetch(`/api/tasks/${taskId}/help-flag`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({isHelpNeeded: newValue})
        });

        const data = await res.json();
        
        if (data.success) {
            currentTask.isHelpNeeded = newValue;
            
            if (newValue) {
                document.getElementById('helpSection').style.display = 'block';
                document.getElementById('messagesSection').style.display = 'block';
                updateHelpButtonDisplay(true);
                await loadMessages();
            } else {
                document.getElementById('helpSection').style.display = 'none';
                document.getElementById('messagesSection').style.display = 'none';
                updateHelpButtonDisplay(false);
                document.getElementById('messagesList').innerHTML = '';
                document.getElementById('messageInput').value = '';
            }
        } else {
            alert(data.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error('Error toggling help flag:', error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}

async function loadMessages() {
    try {
        const res = await fetch(`/api/help-messages/task/${taskId}`);
        const messages = await res.json();

        const messagesList = document.getElementById('messagesList');
        
        if (messages.length === 0) {
            messagesList.innerHTML = '<div class="empty-state">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }

        messagesList.innerHTML = messages.map(m => `
            <div class="message-box">
                <div class="message-author">${escapeHtml(m.senderUsername)}</div>
                <div class="message-time">${formatDate(m.createdAt)}</div>
                <div class="message-text">${escapeHtml(m.message)}</div>
            </div>
        `).join('');

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¸‹ã«
        messagesList.scrollTop = messagesList.scrollHeight;
    } catch (error) {
        console.error('Error loading messages:', error);
        document.getElementById('messagesList').innerHTML = '<div class="empty-state">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    }
}

async function sendMessage() {
    const message = document.getElementById('messageInput').value;
    
    if (!message.trim()) {
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    if (!currentTask.isHelpNeeded) {
        alert('ãƒ˜ãƒ«ãƒ—ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“');
        return;
    }

    try {
        const res = await fetch('/api/help-messages', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({taskId, message})
        });

        const data = await res.json();
        
        if (data.success) {
            document.getElementById('messageInput').value = '';
            await loadMessages();
        } else {
            alert(data.message || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
    return text.replace(/[&<>"']/g, m => map[m]);
}

function formatDate(dateString) {
    if (!dateString) return '-';
    try {
        const date = new Date(dateString);
        return date.toLocaleString('ja-JP', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return dateString;
    }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
window.onclick = function(event) {
    const menu = document.getElementById('statusMenu');
    if (event.target !== document.getElementById('statusBtn')) {
        menu.classList.remove('show');
    }
}
</script>

</body>
</html>
